<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>後台管理 - 點餐系統</title>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }
    #container {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px;
    }
    /* 標題 */
    #header {
      padding: 20px;
      background-color: #007bff;
      color: #fff;
      text-align: center;
      border-bottom: 4px solid #0056b3;
    }
    #header h1 {
      margin: 0;
      font-size: 24px;
    }
    /* 登入表單 */
    #loginSection {
      max-width: 400px;
      margin: 50px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
    }
    #loginSection h2 {
      margin-top: 0;
      text-align: center;
    }
    form {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-top: 10px;
      font-weight: bold;
    }
    input {
      margin-top: 5px;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      margin-top: 20px;
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #218838;
    }
    #loginError {
      margin-top: 10px;
      color: red;
      text-align: center;
    }
    /* 管理後台面板 */
    #adminPanel {
      display: none;
      margin-top: 20px;
    }
    #adminPanel table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    tr:hover {
      background-color: #ddd;
    }
    /* 新增取消訂單與簡訊通知按鈕 */
    .actionButton {
      background-color: #dc3545;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .actionButton:hover {
      background-color: #c82333;
    }
    .smsButton {
      background-color: #17a2b8;
    }
    .smsButton:hover {
      background-color: #138496;
    }
    #logoutButton {
      background-color: #dc3545;
      margin-bottom: 20px;
    }
    #logoutButton:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="header">
      <h1>後台管理 - 點餐系統</h1>
    </div>
    
    <!-- 登入區 -->
    <div id="loginSection">
      <h2>後台登入</h2>
      <form id="loginForm">
        <label for="username">帳號：</label>
        <input type="text" id="username" placeholder="username" required>
        <label for="password">密碼：</label>
        <input type="password" id="password" placeholder="password" required>
        <button type="submit">登入</button>
      </form>
      <p id="loginError"></p>
    </div>
    
    <!-- 管理後台面板 -->
    <div id="adminPanel">
      <button id="logoutButton">登出</button>
      <h3>訂單列表</h3>
      <table id="orderTable">
        <thead>
          <tr>
            <th>訂單編號</th>
            <th>名字</th>
            <th>電話</th>
            <th>餐點內容</th>
            <th>總價 ($)</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // 後台使用的 API 基本 URL
      const apiBaseUrl = "https://6437-2402-7500-9fd-b110-c46a-d722-d2d6-6abb.ngrok-free.app";
      const orderTableBody = document.querySelector("#orderTable tbody");
      let pollingInterval;
      
      // 定義產品價格對照表，若需要計算備用
      const productPrices = {
        "米腸": 30,
        "香腸": 25,
        "大腸包小腸": 50
      };
      
      // 登入表單處理
      document.getElementById("loginForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        if (username === "admin" && password === "password") {
          // 登入成功後隱藏登入區、顯示後台面板，並啟動訂單輪詢
          document.getElementById("loginSection").style.display = "none";
          document.getElementById("adminPanel").style.display = "block";
          startShortPolling();
        } else {
          document.getElementById("loginError").textContent = "帳號或密碼錯誤！";
        }
      });
      
      // 登出按鈕：停止輪詢，返回登入狀態
      document.getElementById("logoutButton").addEventListener("click", function() {
        clearInterval(pollingInterval);
        document.getElementById("adminPanel").style.display = "none";
        document.getElementById("loginSection").style.display = "block";
      });
      
      // 取消訂單函式
      function cancelOrder(orderId) {
        if (confirm("確認要取消此訂單嗎？")) {
          fetch(`${apiBaseUrl}/cancelOrder/${orderId}`, {
            method: "DELETE",
            headers: { "Accept": "application/json" }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`取消訂單失敗, 狀態碼: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            alert("訂單已取消");
            shortPolling(); // 取消後重新更新列表
          })
          .catch(error => {
            console.error("取消訂單時發生錯誤:", error);
            alert("取消訂單時發生錯誤");
          });
        }
      }
      
      // 簡訊通知函式：利用 sms URL scheme 跳出短信APP (僅在移動裝置上有效)
      function sendSMS(order) {
        // 預設短信內容 (可根據需求做調整)
        const message = `親愛的 ${order.name} 您好，您的訂單編號 ${order.id} 已完成，請儘速至門市取餐，謝謝！`;
        // 組成 sms:// 的 URL (不同平台可能略有差異)
        const smsUrl = `sms:${order.phone}?body=${encodeURIComponent(message)}`;
        // 透過改變 window.location.href 來呼叫簡訊程式 (手機上會跳出簡訊APP)
        window.location.href = smsUrl;
      }
      
      // 短輪詢函式：向後端請求最新訂單資料
      function shortPolling(){
        fetch(`${apiBaseUrl}/getOrders`, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "ngrok-skip-browser-warning": "true"
          },
          cache: "no-store"
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`網路請求失敗，狀態碼: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("取得訂單資料:", data);
          updateOrdersTable(data);
        })
        .catch(error => {
          console.error("輪詢資料時發生錯誤:", error);
        });
      }
      
      // 啟動短輪詢，每秒一次
      function startShortPolling(){
        console.log("開始短輪詢訂單資料...");
        pollingInterval = setInterval(shortPolling, 1000);
      }
      
      // 更新訂單表格內容
      function updateOrdersTable(orders) {
        orderTableBody.innerHTML = "";
        orders.forEach((order, index) => {
          let itemsText = "";
          if (Array.isArray(order.items)) {
            itemsText = order.items
              .map(item => `${item.dish} (${item.quantity}個, $${item.itemTotal})`)
              .join(" / ");
          } else {
            itemsText = order.dish || "";
          }
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.id || index + 1}</td>
            <td>${order.name}</td>
            <td>${order.phone}</td>
            <td>${itemsText}</td>
            <td>${order.totalPrice || ''}</td>
          `;
          // 新增操作儲存格
          const actionCell = document.createElement("td");
          
          // 取消訂單按鈕
          const cancelBtn = document.createElement("button");
          cancelBtn.textContent = "取消訂單";
          cancelBtn.className = "actionButton";
          cancelBtn.addEventListener("click", function () {
            cancelOrder(order.id);
          });
          actionCell.appendChild(cancelBtn);
          
          // 簡訊通知按鈕
          const smsBtn = document.createElement("button");
          smsBtn.textContent = "發送簡訊";
          smsBtn.className = "actionButton smsButton";
          smsBtn.addEventListener("click", function () {
            sendSMS(order);
          });
          actionCell.appendChild(smsBtn);
          
          row.appendChild(actionCell);
          orderTableBody.appendChild(row);
        });
      }
    });
  </script>
</body>
</html>
